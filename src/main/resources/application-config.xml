<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:cxf="http://camel.apache.org/schema/cxf" xmlns:camel="http://camel.apache.org/schema/spring"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context.xsd
                           http://camel.apache.org/schema/cxf
                           http://camel.apache.org/schema/cxf/camel-cxf.xsd
                           http://camel.apache.org/schema/spring
                           http://camel.apache.org/schema/spring/camel-spring.xsd">

	<context:property-placeholder location="classpath:datasource.properties" />
	<bean id="addressBaseDataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
		<property name="driverClassName" value="org.postgresql.Driver"/>
		<property name="url" value="${datasource.url}"/>
		<property name="username" value="${datasource.username}"/>
		<property name="password" value="${datasource.password}"/>
	</bean>
	<bean id="sql" class="org.apache.camel.component.sql.SqlComponent">
		<property name="dataSource" ref="addressBaseDataSource"/>
	</bean>

	<bean id="addressingService" class="uk.gov.dwp.service.AddressingService" />
	<bean id="OSPlacesPostcodeAdapter" class="uk.gov.dwp.service.osplaces.Adapter" />
	<bean id="DatabasePostcodeBuilder" class="uk.gov.dwp.service.database.PostcodeBuilder" />
	<bean id="DatabasePostcodeAdapter" class="uk.gov.dwp.service.database.Adapter" />
	<bean id="DatabaseUprnBuilder" class="uk.gov.dwp.service.database.UprnBuilder" />
	<bean id="ExceptionProcessor" class="uk.gov.dwp.service.ExceptionProcessor" />
	<bean id="RESTExceptionResponseSetter" class="uk.gov.dwp.service.osplaces.RESTExceptionResponseSetter" />
	<bean id="DatabaseExceptionResponseSetter" class="uk.gov.dwp.service.database.DatabaseExceptionResponseSetter" />
	<bean id="QASExceptionResponseSetter" class="uk.gov.dwp.service.qas.ondemand_2011_03.QASExceptionResponseSetter" />

	<bean id="propsFunction" class="uk.gov.dwp.service.FallBackPropertiesPlaceHolder" />
	

	<camel:endpoint id="osplaces" uri="{{props:osaddress.endpoint}}" />


	<camel:camelContext >
		<camel:propertyPlaceholder id="properties" location="none" ignoreMissingLocation="true">
			<camel:propertiesFunction ref="propsFunction"/>
		</camel:propertyPlaceholder>
		<camel:dataFormats>
			<camel:json id="OSPlacesPostcodeResponse" library="Jackson" unmarshalTypeName="uk.gov.dwp.service.osplaces.postcode.Response" />
		</camel:dataFormats>
		
		<!-- Global Exception Handler -->
		<camel:onException id="GLOBAL_EXCEPTION_HANDLER">
			<camel:exception>java.lang.Exception</camel:exception>
			<camel:handled>
				<camel:constant>true</camel:constant>
			</camel:handled>
			
			<camel:process ref="ExceptionProcessor"></camel:process>
			
		</camel:onException>


		<!-- REST ROUTE: For non-legacy requests -->
		<!-- OS Places -->
		<camel:route id="REST_ROUTE_OSPLACES">
			<camel:from uri="cxfrs:bean:addressingRsServerOSPlaces" />
			<camel:setProperty propertyName="EXCEPTION_RESPONSE_SETTER">
				<camel:constant>RESTExceptionResponseSetter</camel:constant>
			</camel:setProperty>
			
			<camel:to uri="direct:call_osplaces" />
			<camel:to uri="OSPlacesPostcodeAdapter" id="ADAPTER_OSPLACES"/>
		</camel:route>
		<!-- Database - AddressBase on PostgreSQL -->
		<camel:route id="REST_ROUTE_DATABASE">
			<camel:from uri="cxfrs:bean:addressingRsServerDatabase" />
			<camel:setProperty propertyName="EXCEPTION_RESPONSE_SETTER">
				<camel:constant>DatabaseExceptionResponseSetter</camel:constant>
			</camel:setProperty>

			<camel:to uri="direct:call_database" />
			<camel:to uri="DatabasePostcodeAdapter" id="ADAPTER_DATABASE"/>
		</camel:route>

		<!-- JMS ROUTE: For JMS requests -->
<!-- 		<camel:route id="JMS_ROUTE">
			<camel:from uri="activemq:queue:addresslookup" />
			<camel:setProperty propertyName="EXCEPTION_RESPONSE_SETTER">
				<camel:constant>RESTExceptionResponseSetter</camel:constant>
			</camel:setProperty>
			<camel:setHeader headerName="operationName">
  				<camel:constant>getByPostcode</camel:constant>
			</camel:setHeader>
			
			<camel:log message="${body}"/>
			<camel:to uri="direct:call_osplaces" />
			<camel:to uri="OSPlacesPostcodeAdapter" id="JMS_ADAPTER"/>
			
		</camel:route> -->
		<!-- LEGACY ROUTES: There is one route defined for each supported QAS version -->
		<!-- OS Places -->
 		<camel:route>
			<camel:from uri="cxf:bean:OnDemand-2011-03-Endpoint-OSPlaces" />
			<camel:setProperty propertyName="EXCEPTION_RESPONSE_SETTER">
				<camel:constant>QASExceptionResponseSetter</camel:constant>
			</camel:setProperty>
			
			<camel:choice>
				<camel:when>
					<camel:simple>${header.operationName} == 'DoSearch'</camel:simple>
					<camel:setHeader headerName="operationName">
						<camel:constant>getByPostcode</camel:constant>
					</camel:setHeader>
					<camel:to uri="OnDemand-2011-03-Inbound-PostCode-Search-Adapter" />
					<camel:to uri="direct:call_osplaces" />
					<camel:to uri="OnDemand-2011-03-Outbound-Postcode-Search-Adapter-OSPlaces" />
				</camel:when>
		 		<camel:when>
					<camel:simple>${header.operationName} == 'DoGetAddress'</camel:simple>
					<camel:setHeader headerName="operationName">
						<camel:constant>getByUprn</camel:constant>
					</camel:setHeader>
					<camel:to uri="OnDemand-2011-03-Inbound-Uprn-Search-Adapter" />
					<camel:to uri="direct:call_osplaces" />
					<camel:to uri="OnDemand-2011-03-Outbound-Uprn-Search-Adapter-OSPlaces" />
				</camel:when>
			</camel:choice>
		</camel:route>
		<!-- Database - AddressBase on PostgreSQL -->
		<camel:route>
			<camel:from uri="cxf:bean:OnDemand-2011-03-Endpoint-Database" />
			<camel:setProperty propertyName="EXCEPTION_RESPONSE_SETTER">
				<camel:constant>QASExceptionResponseSetter</camel:constant>
			</camel:setProperty>

			<camel:choice>
				<camel:when>
					<camel:simple>${header.operationName} == 'DoSearch'</camel:simple>
					<camel:setHeader headerName="operationName">
						<camel:constant>getByPostcode</camel:constant>
					</camel:setHeader>
					<camel:to uri="OnDemand-2011-03-Inbound-PostCode-Search-Adapter" />
					<camel:to uri="direct:call_database" />
					<camel:to uri="OnDemand-2011-03-Outbound-Postcode-Search-Adapter-Database" />
				</camel:when>
				<camel:when>
					<camel:simple>${header.operationName} == 'DoGetAddress'</camel:simple>
					<camel:setHeader headerName="operationName">
						<camel:constant>getByUprn</camel:constant>
					</camel:setHeader>
					<camel:to uri="OnDemand-2011-03-Inbound-Uprn-Search-Adapter" />
					<camel:to uri="direct:call_database" />
					<camel:to uri="OnDemand-2011-03-Outbound-Uprn-Search-Adapter-Database" />
				</camel:when>
			</camel:choice>
		</camel:route>

		<!-- 
			 Common Route which sends search queries to OS Places. The response is unmarshalled in to a 
		     uk.gov.dwp.service.osplaces.postcode.Response object which can then be adapted to the correct format
		     in the "calling" route
		-->
		<camel:route id="COMMON_ROUTE_OSPLACES">
			<camel:from uri="direct:call_osplaces" />
			<camel:log message="${body}"/>
						
			<camel:setHeader headerName="CamelHttpMethod">
				<camel:constant>GET</camel:constant>
			</camel:setHeader>
			<camel:setHeader headerName="CamelHttpUri">
				<camel:constant>{{props:osaddress.endpoint}}</camel:constant>
			</camel:setHeader>

			<camel:choice>
				<camel:when>
					<camel:simple>${header.operationName} == 'getByPostcode'</camel:simple>
					<camel:setHeader headerName="CamelHttpPath">
						<camel:constant>places/v1/addresses/postcode</camel:constant>
					</camel:setHeader>
					<camel:setHeader headerName="CamelHttpQuery">
						<camel:simple>postcode=${body}&amp;format=json&amp;dataset=DPA&amp;key=STUB_AUTH_KEY</camel:simple>
					</camel:setHeader>			
				</camel:when>
							
				<camel:when>
					<camel:simple>${header.operationName} == 'getByUprn'</camel:simple>
					<camel:setHeader headerName="CamelHttpPath">
						<camel:constant>places/v1/addresses/uprn</camel:constant>
					</camel:setHeader>
					<camel:setHeader headerName="CamelHttpQuery">
						<camel:simple>uprn=${body}&amp;format=json&amp;dataset=DPA&amp;key=STUB_AUTH_KEY</camel:simple>
					</camel:setHeader>				
				</camel:when>
				
			</camel:choice>
				
			<camel:to uri="{{props:osaddress.endpoint}}" />
			<camel:unmarshal id="UNMARSHALL_REMOTE_RESPONSE_OSPLACES" ref="OSPlacesPostcodeResponse" />
			
		</camel:route>

		<!--
			 Common Route which sends SQL queries to a PostgreSQL database containing AddressBase data. The results
			 are mapped to a List (one entry for each row) of Maps (one entry for each column using the column
			 name as the key) which can then be adapted to the correct format in the "calling" route
		-->
		<camel:route id="COMMON_ROUTE_DATABASE">
			<camel:from uri="direct:call_database"/>

			<camel:choice>
				<camel:when>
					<camel:simple>${header.operationName} == 'getByPostcode'</camel:simple>
					<camel:setHeader headerName="postcode">
						<camel:method bean="DatabasePostcodeBuilder" method="buildPostcode(${body}, '%')"/>
					</camel:setHeader>
					<camel:log message="Executing query for postcode with parameter: '${header.postcode}'"/>
					<camel:to uri="sql:SELECT * FROM addressbase WHERE (lower(replace(POSTCODE, ' ', ''))) LIKE :#postcode LIMIT 100"/>
				</camel:when>

				<camel:when>
					<camel:simple>${header.operationName} == 'getByUprn'</camel:simple>
					<camel:setHeader headerName="uprn">
						<camel:method bean="DatabaseUprnBuilder" method="buildUprn(${body})"/>
					</camel:setHeader>
					<camel:log message="Executing query for uprn with parameter: '${header.uprn}'"/>
					<camel:to uri="sql:SELECT * FROM addressbase WHERE UPRN = :#uprn::bigint"/>
				</camel:when>
			</camel:choice>
		</camel:route>
	</camel:camelContext>

	<!-- LEGACY CONVERTERS: -->
	<bean id="OnDemand-2011-03-Inbound-PostCode-Search-Adapter" class="uk.gov.dwp.service.qas.ondemand_2011_03.PostcodeSearchInboundAdapter" />
	<bean id="OnDemand-2011-03-Outbound-Postcode-Search-Adapter-OSPlaces" class="uk.gov.dwp.service.qas.ondemand_2011_03.PostcodeSearchOutboundAdapterOSPlaces" />
	<bean id="OnDemand-2011-03-Outbound-Postcode-Search-Adapter-Database" class="uk.gov.dwp.service.qas.ondemand_2011_03.PostcodeSearchOutboundAdapterDatabase" />
	<bean id="OnDemand-2011-03-Inbound-Uprn-Search-Adapter" class="uk.gov.dwp.service.qas.ondemand_2011_03.UprnSearchInboundAdapter" />

	<bean id="OnDemand-2011-03-Outbound-Uprn-Search-Adapter-OSPlaces" class="uk.gov.dwp.service.qas.ondemand_2011_03.UprnSearchOutboundAdapterOSPlaces" />
	<bean id="OnDemand-2011-03-Outbound-Uprn-Search-Adapter-Database" class="uk.gov.dwp.service.qas.ondemand_2011_03.UprnSearchOutboundAdapterDatabase" />	
	
<!-- 	<bean id="activemq" 
      class="org.apache.activemq.camel.component.ActiveMQComponent">
      <property name="brokerURL" value="tcp://localhost:61616"/>
              <property name="userName" value="user"/>
        <property name="password" value="password"/>
      
   </bean> -->

</beans>
